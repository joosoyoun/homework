<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ìˆ™ì œ ì œì¶œ</title>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@2.6.4/dist/email.min.js"></script>
  <style>
    body { background: #fff0f6; font-family: 'Noto Sans KR', sans-serif; margin: 0; padding: 0; }
    .container { max-width: 700px; margin: 40px auto; background: #fff; border-radius: 20px; box-shadow: 0 4px 24px rgba(255, 192, 203, 0.2); padding: 40px 30px 30px 30px; }
    .title { background: #ffb6d5; color: #fff; font-size: 2rem; font-weight: bold; border-radius: 20px; padding: 16px 32px; display: inline-block; margin-bottom: 30px; }
    .top-form { margin-bottom: 40px; text-align: center; }
    .problem-img { display: block; margin: 0 auto 20px auto; max-width: 100%; border-radius: 12px; box-shadow: 0 2px 8px rgba(255, 182, 213, 0.15); }
    .answer-form { margin-bottom: 50px; background: #ffe4f0; border-radius: 16px; padding: 30px 20px 20px 20px; box-shadow: 0 2px 8px rgba(255, 182, 213, 0.08); }
    .label { font-size: 1.1rem; font-weight: 500; margin-bottom: 10px; display: block; color: #d63384; }
    .input, .textarea { width: 100%; font-size: 1.1rem; border-radius: 8px; border: 1.5px solid #ffb6d5; padding: 12px; margin-bottom: 18px; background: #fff; box-sizing: border-box; resize: none; }
    .textarea { min-height: 120px; height: 180px; max-height: 400px; }
    .submit-btn { background: #ffb6d5; color: #fff; font-size: 1.1rem; font-weight: bold; border: none; border-radius: 8px; padding: 12px 32px; cursor: pointer; transition: background 0.2s; }
    .submit-btn:hover { background: #d63384; }
    .confirmation { color: #d63384; font-weight: bold; margin-top: 10px; font-size: 1.1rem; display: none; }
    .pad-wrap { position: relative; margin-bottom: 18px; }
    .drawpad { border: 2px solid #ffb6d5; border-radius: 10px; background: #fff; width: 100%; height: 200px; touch-action: none; display: block; margin: 0 auto 8px auto; }
    .clear-btn { position: absolute; right: 10px; top: 10px; background: #fff0f6; color: #d63384; border: 1px solid #ffb6d5; border-radius: 6px; padding: 4px 16px; font-size: 1rem; cursor: pointer; z-index: 2; }
    .clear-btn:hover { background: #ffb6d5; color: #fff; }
  </style>
</head>
<body>
  <div class="container">
    <div class="title">ìˆ™ì œ ì œì¶œ</div>
    <form class="top-form" onsubmit="return false;">
      <label class="label" for="student_name">ì´ë¦„</label>
      <input class="input" type="text" id="student_name" required placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" />
    </form>

    <!-- ë¬¸ì œ 1~6 ë°˜ë³µ -->
    <script>
      const problemCount = 6;
      document.write([...Array(problemCount)].map((_, i) => {
        const idx = i + 1;
        return `
        <form class="answer-form" id="form${idx}">
          <img src="problem${idx}.png" alt="ë¬¸ì œ ${idx}" class="problem-img">
          <label class="label" for="answer${idx}">ì •ë‹µ</label>
          <input class="input" type="text" id="answer${idx}" required placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”">
          <label class="label">í’€ì´ (ê·¸ë¦¼íŒ)</label>
          <div class="pad-wrap">
            <canvas class="drawpad" id="pad${idx}" width="600" height="200"></canvas>
            <button type="button" class="clear-btn" data-pad="${idx}">ì§€ìš°ê¸°</button>
          </div>
          <button class="submit-btn" type="submit">ì œì¶œ</button>
          <div class="confirmation" id="confirmation${idx}">ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!</div>
        </form>`;
      }).join(''));
    </script>
  </div>

  <script>
    // âœ… EmailJS ì´ˆê¸°í™”
    (function () {
      emailjs.init('wLE5l2YjXRubD8MjC'); // ë³¸ì¸ EmailJS Public Key
    })();

    function getStudentName() {
      return document.getElementById('student_name').value;
    }

    function sendForm(dataObj, confirmationId) {
      const templateParams = {
        student_name: dataObj.student_name,
        answers: `
ì •ë‹µ: ${dataObj.answers}

í’€ì´ ì´ë¯¸ì§€:
<img src="${dataObj.solution}" style="max-width: 100%;" />
        `
      };

      emailjs.send('problem', 'template_65k6mg6', templateParams)
        .then(() => {
          document.getElementById(confirmationId).style.display = 'block';
        })
        .catch(error => {
          alert('âŒ ë©”ì¼ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          console.error(error);
        });
    }

    // ğŸ–Œ ê·¸ë¦¼íŒ ì´ˆê¸°í™”
    function setupPad(padId) {
      const canvas = document.getElementById('pad' + padId);
      const ctx = canvas.getContext('2d');
      let drawing = false;
      let lastX = 0, lastY = 0;

      function getXY(e) {
        if (e.touches) {
          const rect = canvas.getBoundingClientRect();
          return [e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top];
        } else {
          return [e.offsetX, e.offsetY];
        }
      }

      canvas.addEventListener('mousedown', e => { drawing = true; [lastX, lastY] = getXY(e); });
      canvas.addEventListener('touchstart', e => { drawing = true; [lastX, lastY] = getXY(e); });
      canvas.addEventListener('mousemove', e => {
        if (!drawing) return;
        const [x, y] = getXY(e);
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#d63384';
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.stroke();
        [lastX, lastY] = [x, y];
      });
      canvas.addEventListener('touchmove', e => {
        if (!drawing) return;
        e.preventDefault();
        const [x, y] = getXY(e);
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#d63384';
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.stroke();
        [lastX, lastY] = [x, y];
      }, { passive: false });

      canvas.addEventListener('mouseup', () => drawing = false);
      canvas.addEventListener('mouseleave', () => drawing = false);
      canvas.addEventListener('touchend', () => drawing = false);

      // ì§€ìš°ê¸° ë²„íŠ¼
      document.querySelector(`.clear-btn[data-pad="${padId}"]`).addEventListener('click', () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      });
    }

    // ì´ˆê¸°í™”
    for (let i = 1; i <= problemCount; i++) setupPad(i);

    // ì œì¶œ ì´ë²¤íŠ¸ ë“±ë¡
    for (let i = 1; i <= problemCount; i++) {
      document.getElementById('form' + i).addEventListener('submit', function (e) {
        e.preventDefault();
        const student_name = getStudentName();
        if (!student_name) {
          alert('ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”!');
          document.getElementById('student_name').focus();
          return;
        }

        const answer = document.getElementById('answer' + i).value;
        const pad = document.getElementById('pad' + i);
        const solutionImg = pad.toDataURL('image/png');

        sendForm({
          student_name,
          answers: answer,
          solution: solutionImg
        }, 'confirmation' + i);
      });
    }
  </script>
</body>
</html>
